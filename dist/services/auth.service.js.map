{"version":3,"sources":["../../src/services/auth.service.ts"],"sourcesContent":["import { compare, hash } from 'bcrypt';\r\nimport { sign } from 'jsonwebtoken';\r\nimport { SECRET_KEY } from '@config';\r\nimport DB from '@databases';\r\nimport { CreateUserDto } from '@dtos/users.dto';\r\nimport { HttpException } from '@exceptions/HttpException';\r\nimport { DataStoredInToken, TokenData } from '@interfaces/auth.interface';\r\nimport { User } from '@interfaces/users.interface';\r\nimport { isEmpty } from '@utils/util';\r\n\r\nclass AuthService {\r\n  public users = DB.Users;\r\n\r\n  public async signup(userData: CreateUserDto): Promise<User> {\r\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\r\n\r\n    const findUser: User = await this.users.findOne({ where: { email: userData.email } });\r\n    if (findUser) throw new HttpException(409, `This email ${userData.email} already exists`);\r\n\r\n    const hashedPassword = await hash(userData.password, 10);\r\n    const createUserData: User = await this.users.create({ ...userData, password: hashedPassword });\r\n\r\n    return createUserData;\r\n  }\r\n\r\n  public async login(userData: CreateUserDto): Promise<{ cookie: string; findUser: User }> {\r\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\r\n\r\n    const findUser: User = await this.users.findOne({ where: { email: userData.email } });\r\n    if (!findUser) throw new HttpException(409, `This email ${userData.email} was not found`);\r\n\r\n    const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\r\n    if (!isPasswordMatching) throw new HttpException(409, 'Password not matching');\r\n\r\n    const tokenData = this.createToken(findUser);\r\n    const cookie = this.createCookie(tokenData);\r\n\r\n    return { cookie, findUser };\r\n  }\r\n\r\n  public async logout(userData: User): Promise<User> {\r\n    if (isEmpty(userData)) throw new HttpException(400, 'userData is empty');\r\n\r\n    const findUser: User = await this.users.findOne({ where: { email: userData.email, password: userData.password } });\r\n    if (!findUser) throw new HttpException(409, \"User doesn't exist\");\r\n\r\n    return findUser;\r\n  }\r\n\r\n  public createToken(user: User): TokenData {\r\n    const dataStoredInToken: DataStoredInToken = { id: user.id };\r\n    const secretKey: string = SECRET_KEY;\r\n    const expiresIn: number = 60 * 60;\r\n\r\n    return { expiresIn, token: sign(dataStoredInToken, secretKey, { expiresIn }) };\r\n  }\r\n\r\n  public createCookie(tokenData: TokenData): string {\r\n    return `Authorization=${tokenData.token}; HttpOnly; Max-Age=${tokenData.expiresIn};`;\r\n  }\r\n}\r\n\r\nexport default AuthService;\r\n"],"names":["AuthService","signup","userData","isEmpty","HttpException","findUser","users","findOne","where","email","hashedPassword","hash","password","createUserData","create","login","isPasswordMatching","compare","tokenData","createToken","cookie","createCookie","logout","user","dataStoredInToken","id","secretKey","SECRET_KEY","expiresIn","token","sign","DB","Users"],"mappings":"AAAA;;;;+BA8DA;;aAAA;;wBA9D8B;8BACT;wBACM;kDACZ;+BAEe;sBAGN;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAExB,IAAA,AAAMA,cAAN,MAAMA;IAGJ,MAAaC,OAAOC,QAAuB,EAAiB;QAC1D,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK,qBAAqB;QAEzE,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,OAAO;gBAAEC,OAAOP,SAASO,KAAK;YAAC;QAAE;QACnF,IAAIJ,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,WAAW,EAAEF,SAASO,KAAK,CAAC,eAAe,CAAC,EAAE;QAE1F,MAAMC,iBAAiB,MAAMC,IAAAA,YAAI,EAACT,SAASU,QAAQ,EAAE;QACrD,MAAMC,iBAAuB,MAAM,IAAI,CAACP,KAAK,CAACQ,MAAM,CAAC,qCAAKZ;YAAUU,UAAUF;;QAE9E,OAAOG;IACT;IAEA,MAAaE,MAAMb,QAAuB,EAA+C;QACvF,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK,qBAAqB;QAEzE,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,OAAO;gBAAEC,OAAOP,SAASO,KAAK;YAAC;QAAE;QACnF,IAAI,CAACJ,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,CAAC,WAAW,EAAEF,SAASO,KAAK,CAAC,cAAc,CAAC,EAAE;QAE1F,MAAMO,qBAA8B,MAAMC,IAAAA,eAAO,EAACf,SAASU,QAAQ,EAAEP,SAASO,QAAQ;QACtF,IAAI,CAACI,oBAAoB,MAAM,IAAIZ,4BAAa,CAAC,KAAK,yBAAyB;QAE/E,MAAMc,YAAY,IAAI,CAACC,WAAW,CAACd;QACnC,MAAMe,SAAS,IAAI,CAACC,YAAY,CAACH;QAEjC,OAAO;YAAEE;YAAQf;QAAS;IAC5B;IAEA,MAAaiB,OAAOpB,QAAc,EAAiB;QACjD,IAAIC,IAAAA,aAAO,EAACD,WAAW,MAAM,IAAIE,4BAAa,CAAC,KAAK,qBAAqB;QAEzE,MAAMC,WAAiB,MAAM,IAAI,CAACC,KAAK,CAACC,OAAO,CAAC;YAAEC,OAAO;gBAAEC,OAAOP,SAASO,KAAK;gBAAEG,UAAUV,SAASU,QAAQ;YAAC;QAAE;QAChH,IAAI,CAACP,UAAU,MAAM,IAAID,4BAAa,CAAC,KAAK,sBAAsB;QAElE,OAAOC;IACT;IAEOc,YAAYI,IAAU,EAAa;QACxC,MAAMC,oBAAuC;YAAEC,IAAIF,KAAKE,EAAE;QAAC;QAC3D,MAAMC,YAAoBC,kBAAU;QACpC,MAAMC,YAAoB,KAAK;QAE/B,OAAO;YAAEA;YAAWC,OAAOC,IAAAA,kBAAI,EAACN,mBAAmBE,WAAW;gBAAEE;YAAU;QAAG;IAC/E;IAEOP,aAAaH,SAAoB,EAAU;QAChD,OAAO,CAAC,cAAc,EAAEA,UAAUW,KAAK,CAAC,oBAAoB,EAAEX,UAAUU,SAAS,CAAC,CAAC,CAAC;IACtF;;aAhDOtB,QAAQyB,kBAAE,CAACC,KAAK;;AAiDzB;MAEA,WAAehC"}